#!/bin/bash -exu

RUN_DIR=/var/vcap/sys/run/etcd_testconsumer
LOG_DIR=/var/vcap/sys/log/etcd_testconsumer
CERT_DIR="/var/vcap/jobs/etcd_testconsumer/config/certs"

function create_directories_and_chown_to_vcap() {
  mkdir -p ${LOG_DIR}
  chown -R vcap:vcap ${LOG_DIR}

  # This is here for upgrade purposes to ensure RUN_DIR is owned by vcap
  mkdir -p ${RUN_DIR}
  chown -R vcap:vcap ${RUN_DIR}

  mkdir -p ${CERT_DIR}
  chown -R vcap:vcap ${CERT_DIR}
}

function emit_event_to_datadog() {
 <%=
   if_p("etcd_testconsumer.datadog_api_key") do |key|
    "curl -X POST -H 'Content-type: application/json' \
    -d '{
      \"title\": \"testconsumer start\",
      \"text\": \"starting etcd testconsumer now\",
      \"priority\": \"normal\",
      \"tags\": [\"eats:testconsumer\"],
      \"alert_type\": \"info\"
      }' \
      'https://app.datadoghq.com/api/v1/events?api_key=#{key}'"
   end
  %>
}

function main() {
  create_directories_and_chown_to_vcap
  emit_event_to_datadog
}

main
